<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDTRE - Report Completo Aziende Target</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .print\:hidden { display: none !important; }
            .print\:p-0 { padding: 0 !important; }
            .print\:shadow-none { box-shadow: none !important; }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        .filter-dropdown {
            position: relative;
            display: inline-block;
        }
        .filter-panel {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 8px;
        }
        .filter-panel.active {
            display: block;
        }
        .filter-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .filter-option:hover {
            background: #f3f4f6;
        }
        .filter-option.selected {
            background: #dbeafe;
            border-left: 3px solid #2563eb;
        }
        .filter-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .filter-actions {
            padding: 12px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
            background: #f9fafb;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
    
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto"></div>
            <p class="text-white mt-4 font-semibold">Caricamento...</p>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div id="notification" class="hidden fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-xl z-50 font-semibold"></div>

    <!-- HEADER -->
    <div class="bg-white shadow-xl p-4 print:hidden">
        <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-4">
            <div class="flex items-center gap-4">
                <button id="homeBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </button>
                <div>
                    <h1 class="text-2xl font-bold text-blue-900">GDTRE Private Equity</h1>
                    <p class="text-sm text-gray-600">Report Completo ‚Ä¢ <span id="totalCount">0</span> Aziende</p>
                </div>
            </div>
            
            <!-- FILTRI -->
            <div class="flex items-center gap-3">
                <!-- Filtro ATECO -->
                <div class="filter-dropdown">
                    <button id="atecoFilterBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-semibold text-sm flex items-center gap-2 transition-colors">
                        <span>üè¢ Codice ATECO</span>
                        <span id="atecoCount" class="hidden bg-blue-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div id="atecoPanel" class="filter-panel" onclick="event.stopPropagation()">
                        <div class="p-3 border-b bg-gray-50">
                            <input type="text" id="atecoSearch" placeholder="Cerca ATECO..." class="w-full px-3 py-2 border rounded-lg text-sm" onclick="event.stopPropagation()">
                            <div id="atecoTempCount" class="mt-2 text-xs text-gray-600 font-semibold hidden">
                                <span class="text-blue-600" id="atecoTempCountValue">0</span> selezionati
                            </div>
                            <div id="atecoAvailable" class="mt-1 text-xs text-gray-500 italic hidden">
                                <span id="atecoAvailableCount">0</span> codici disponibili
                            </div>
                        </div>
                        <div id="atecoOptions" class="max-h-64 overflow-y-auto">
                            <!-- Options will be populated dynamically -->
                        </div>
                        <div class="filter-actions">
                            <button id="atecoApply" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm">
                                Applica
                            </button>
                            <button id="atecoReset" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold text-sm">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filtro Provincia -->
                <div class="filter-dropdown">
                    <button id="provinciaFilterBtn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg font-semibold text-sm flex items-center gap-2 transition-colors">
                        <span>üìç Provincia</span>
                        <span id="provinciaCount" class="hidden bg-blue-600 text-white text-xs px-2 py-0.5 rounded-full">0</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    <div id="provinciaPanel" class="filter-panel" onclick="event.stopPropagation()">
                        <div class="p-3 border-b bg-gray-50">
                            <input type="text" id="provinciaSearch" placeholder="Cerca provincia..." class="w-full px-3 py-2 border rounded-lg text-sm" onclick="event.stopPropagation()">
                            <div id="provinciaTempCount" class="mt-2 text-xs text-gray-600 font-semibold hidden">
                                <span class="text-blue-600" id="provinciaTempCountValue">0</span> selezionate
                            </div>
                            <div id="provinciaAvailable" class="mt-1 text-xs text-gray-500 italic hidden">
                                <span id="provinciaAvailableCount">0</span> province disponibili
                            </div>
                        </div>
                        <div id="provinciaOptions" class="max-h-64 overflow-y-auto">
                            <!-- Options will be populated dynamically -->
                        </div>
                        <div class="filter-actions">
                            <button id="provinciaApply" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm">
                                Applica
                            </button>
                            <button id="provinciaReset" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold text-sm">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- CATEGORY SELECTOR -->
                <div class="flex gap-2">
                    <button data-category="daValutare" class="category-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all bg-blue-600 text-white">
                        üìã Da Valutare (<span class="count">0</span>)
                    </button>
                    <button data-category="preferiti" class="category-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all bg-gray-200 text-gray-700 hover:bg-gray-300">
                        ‚≠ê Preferiti (<span class="count">0</span>)
                    </button>
                    <button data-category="scartati" class="category-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all bg-gray-200 text-gray-700 hover:bg-gray-300">
                        üóëÔ∏è Scartati (<span class="count">0</span>)
                    </button>
                </div>

                <button id="syncBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold flex items-center gap-2">
                    <svg id="syncIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                    </svg>
                    Sync
                </button>
                
                <div class="text-right text-sm">
                    <p class="text-gray-600" id="lastUpdate">Mai aggiornato</p>
                    <p class="text-xs text-gray-500 font-semibold">Slide <span id="currentSlide">1</span>/<span id="totalSlides">1</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-1 flex items-stretch p-6 print:p-0">
        <div class="bg-white rounded-xl shadow-2xl w-full p-10 relative print:shadow-none flex flex-col">
            <div id="slideContent" class="flex-1 flex flex-col gap-4 pb-20">
                <!-- Companies will be inserted here -->
            </div>
            
            <!-- FOOTER -->
            <div class="absolute bottom-4 right-8 flex justify-end text-sm text-gray-400">
                <span>¬© GDTRE 2025</span>
            </div>
        </div>
    </div>

    <!-- NAVIGATION -->
    <div class="bg-white border-t p-4 print:hidden">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between mb-3">
                <button id="prevBtn" disabled class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold bg-gray-200 text-gray-400 cursor-not-allowed">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Precedente
                </button>
                
                <div id="navDots" class="flex gap-2">
                    <!-- Dots will be inserted here -->
                </div>
                
                <button id="nextBtn" class="flex items-center gap-2 px-6 py-3 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700">
                    Successivo
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
            <div class="text-center">
                <p class="text-sm text-gray-600" id="navInfo">
                    üìä Aziende 1-2 di 0 visibili
                </p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbxvxloimpAgU8dLpsKtJ0YhjRNbxF4oCPDF-d7EteLQDdV9nR0tYkbpgeH1Lzt7kBoQ/exec';
        const COMPANIES_PER_SLIDE = 4;
        const AUTO_REFRESH_INTERVAL = 60000;

        // ============================================
        // STATE
        // ============================================
        let allData = {
            daValutare: [],
            preferiti: [],
            scartati: []
        };
        let currentCategory = 'daValutare';
        let currentSlide = 0;
        let lastUpdate = null;
        
        // Filtri
        let selectedAteco = new Set();
        let selectedProvincie = new Set();
        let allAtecoValues = new Set();
        let allProvincieValues = new Set();

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadData();
            startAutoRefresh();
        });

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            document.getElementById('homeBtn').addEventListener('click', () => goToSlide(0));
            document.getElementById('prevBtn').addEventListener('click', () => prevSlide());
            document.getElementById('nextBtn').addEventListener('click', () => nextSlide());
            document.getElementById('syncBtn').addEventListener('click', () => syncData());
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const category = e.currentTarget.dataset.category;
                    switchCategory(category);
                });
            });
            
            // Filtri ATECO
            document.getElementById('atecoFilterBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFilterPanel('ateco');
            });
            document.getElementById('atecoApply').addEventListener('click', () => applyFilters());
            document.getElementById('atecoReset').addEventListener('click', () => resetFilter('ateco'));
            document.getElementById('atecoSearch').addEventListener('input', (e) => filterOptions('ateco', e.target.value));
            
            // Filtri Provincia
            document.getElementById('provinciaFilterBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFilterPanel('provincia');
            });
            document.getElementById('provinciaApply').addEventListener('click', () => applyFilters());
            document.getElementById('provinciaReset').addEventListener('click', () => resetFilter('provincia'));
            document.getElementById('provinciaSearch').addEventListener('input', (e) => filterOptions('provincia', e.target.value));
            
            // Chiudi dropdown quando si clicca fuori
            document.addEventListener('click', () => {
                document.querySelectorAll('.filter-panel').forEach(panel => panel.classList.remove('active'));
            });
        }

        // ============================================
        // CATEGORY SWITCHING
        // ============================================
        function switchCategory(category) {
            currentCategory = category;
            currentSlide = 0;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                const isActive = btn.dataset.category === category;
                btn.className = `category-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all ${
                    isActive 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`;
            });
            
            // Aggiorna le opzioni disponibili per la nuova categoria
            populateFilterOptions();
            
            renderSlide();
            updateNavigation();
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            showLoading(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'getData' })
                });
                
                const result = await response.json();
                if (result.success) {
                    allData = result.data;
                    lastUpdate = new Date();
                    populateFilterOptions();
                    updateCounts();
                    renderSlide();
                    updateNavigation();
                    updateLastUpdateTime();
                    showNotification('‚úì Dati caricati', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Errore: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function syncData() {
            const syncBtn = document.getElementById('syncBtn');
            const syncIcon = document.getElementById('syncIcon');
            syncIcon.style.animation = 'spin 1s linear infinite';
            syncBtn.disabled = true;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'sync' })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úì Sincronizzazione completata', 'success');
                    await loadData();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('Errore: ' + error.message, 'error');
            } finally {
                syncIcon.style.animation = '';
                syncBtn.disabled = false;
            }
        }

        // ============================================
        // COMPANY ACTIONS
        // ============================================
        async function moveToPreferiti(ragioneSociale) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'moveToPreferiti', ragioneSociale })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úì Aggiunto ai preferiti', 'success');
                    await loadData();
                }
            } catch (error) {
                showNotification('Errore: ' + error.message, 'error');
            }
        }

        async function moveToScartati(ragioneSociale) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'moveToScartati', ragioneSociale })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úì Azienda scartata', 'success');
                    await loadData();
                }
            } catch (error) {
                showNotification('Errore: ' + error.message, 'error');
            }
        }

        async function ripristinaAzienda(ragioneSociale) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'ripristina', ragioneSociale })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úì Azienda ripristinata', 'success');
                    await loadData();
                }
            } catch (error) {
                showNotification('Errore: ' + error.message, 'error');
            }
        }

        // ============================================
        // FILTRI
        // ============================================
        function toggleFilterPanel(filterType) {
            const panelId = filterType === 'ateco' ? 'atecoPanel' : 'provinciaPanel';
            const panel = document.getElementById(panelId);
            const otherPanelId = filterType === 'ateco' ? 'provinciaPanel' : 'atecoPanel';
            
            // Chiudi l'altro pannello
            document.getElementById(otherPanelId).classList.remove('active');
            
            // Se il pannello √® gi√† aperto, chiudilo
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
            } else {
                // Prima di aprire, aggiorna le opzioni disponibili
                populateFilterOptions();
                // Poi apri il pannello
                panel.classList.add('active');
            }
        }
        
        function populateFilterOptions() {
            // Ottieni le aziende della categoria corrente
            let currentCompanies = allData[currentCategory] || [];
            
            // Se ci sono filtri attivi, filtra ulteriormente per mostrare solo opzioni disponibili
            // Se ATECO √® selezionato, filtra per ATECO e poi raccogli le province disponibili
            if (selectedAteco.size > 0) {
                currentCompanies = currentCompanies.filter(c => 
                    c.codiceAteco && selectedAteco.has(c.codiceAteco.trim())
                );
            }
            
            // Se Provincia √® selezionata, filtra per Provincia e poi raccogli gli ATECO disponibili
            let companiesForAteco = allData[currentCategory] || [];
            if (selectedProvincie.size > 0) {
                companiesForAteco = companiesForAteco.filter(c => 
                    c.provincia && selectedProvincie.has(c.provincia.trim())
                );
            }
            
            // Raccogli i valori disponibili dopo i filtri
            allAtecoValues.clear();
            allProvincieValues.clear();
            
            // ATECO disponibili (considerando filtro Provincia se attivo)
            companiesForAteco.forEach(company => {
                if (company.codiceAteco && company.codiceAteco.trim() !== '') {
                    allAtecoValues.add(company.codiceAteco.trim());
                }
            });
            
            // Province disponibili (considerando filtro ATECO se attivo)
            currentCompanies.forEach(company => {
                if (company.provincia && company.provincia.trim() !== '') {
                    allProvincieValues.add(company.provincia.trim());
                }
            });
            
            // Rimuovi selezioni ATECO che non sono pi√π disponibili
            selectedAteco.forEach(ateco => {
                if (!allAtecoValues.has(ateco)) {
                    selectedAteco.delete(ateco);
                }
            });
            
            // Rimuovi selezioni Provincia che non sono pi√π disponibili
            selectedProvincie.forEach(provincia => {
                if (!allProvincieValues.has(provincia)) {
                    selectedProvincie.delete(provincia);
                }
            });
            
            // Popola dropdown ATECO
            const atecoOptions = document.getElementById('atecoOptions');
            atecoOptions.innerHTML = '';
            const sortedAteco = Array.from(allAtecoValues).sort();
            
            if (sortedAteco.length === 0) {
                atecoOptions.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Nessun codice ATECO disponibile</div>';
            } else {
                sortedAteco.forEach(ateco => {
                    const option = createFilterOption(ateco, 'ateco', selectedAteco.has(ateco));
                    atecoOptions.appendChild(option);
                });
            }
            
            // Aggiorna indicatore disponibilit√† ATECO
            const atecoAvailable = document.getElementById('atecoAvailable');
            const atecoAvailableCount = document.getElementById('atecoAvailableCount');
            if (selectedProvincie.size > 0) {
                atecoAvailableCount.textContent = sortedAteco.length;
                atecoAvailable.classList.remove('hidden');
            } else {
                atecoAvailable.classList.add('hidden');
            }
            
            // Popola dropdown Provincia
            const provinciaOptions = document.getElementById('provinciaOptions');
            provinciaOptions.innerHTML = '';
            const sortedProvincie = Array.from(allProvincieValues).sort();
            
            if (sortedProvincie.length === 0) {
                provinciaOptions.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Nessuna provincia disponibile</div>';
            } else {
                sortedProvincie.forEach(provincia => {
                    const option = createFilterOption(provincia, 'provincia', selectedProvincie.has(provincia));
                    provinciaOptions.appendChild(option);
                });
            }
            
            // Aggiorna indicatore disponibilit√† Province
            const provinciaAvailable = document.getElementById('provinciaAvailable');
            const provinciaAvailableCount = document.getElementById('provinciaAvailableCount');
            if (selectedAteco.size > 0) {
                provinciaAvailableCount.textContent = sortedProvincie.length;
                provinciaAvailable.classList.remove('hidden');
            } else {
                provinciaAvailable.classList.add('hidden');
            }
            
            // Aggiorna i contatori dopo la pulizia
            updateFilterCounts();
        }
        
        function createFilterOption(value, filterType, isChecked) {
            const div = document.createElement('div');
            div.className = 'filter-option' + (isChecked ? ' selected' : '');
            div.dataset.value = value;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = isChecked;
            checkbox.id = `${filterType}-${value.replace(/\s+/g, '-')}`;
            
            checkbox.addEventListener('change', (e) => {
                const set = filterType === 'ateco' ? selectedAteco : selectedProvincie;
                if (e.target.checked) {
                    set.add(value);
                    div.classList.add('selected');
                } else {
                    set.delete(value);
                    div.classList.remove('selected');
                }
                updateFilterCounts();
            });
            
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = value;
            label.className = 'cursor-pointer flex-1 text-sm';
            
            // Impedisce solo la propagazione al document (che chiuderebbe il menu)
            div.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            div.appendChild(checkbox);
            div.appendChild(label);
            
            return div;
        }
        
        function filterOptions(filterType, searchTerm) {
            const optionsId = filterType === 'ateco' ? 'atecoOptions' : 'provinciaOptions';
            const options = document.getElementById(optionsId).querySelectorAll('.filter-option');
            
            const term = searchTerm.toLowerCase();
            options.forEach(option => {
                const value = option.dataset.value.toLowerCase();
                option.style.display = value.includes(term) ? 'flex' : 'none';
            });
        }
        
        function applyFilters() {
            currentSlide = 0;
            renderSlide();
            updateNavigation();
            updateFilterCounts();
            
            // Aggiorna le opzioni disponibili in base ai filtri applicati (cascata)
            populateFilterOptions();
            
            // Chiudi i pannelli
            document.querySelectorAll('.filter-panel').forEach(panel => panel.classList.remove('active'));
        }
        
        function resetFilter(filterType) {
            if (filterType === 'ateco') {
                selectedAteco.clear();
                document.querySelectorAll('#atecoOptions input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    cb.closest('.filter-option').classList.remove('selected');
                });
            } else {
                selectedProvincie.clear();
                document.querySelectorAll('#provinciaOptions input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    cb.closest('.filter-option').classList.remove('selected');
                });
            }
            
            applyFilters();
        }
        
        function updateFilterCounts() {
            const atecoCountEl = document.getElementById('atecoCount');
            const provinciaCountEl = document.getElementById('provinciaCount');
            
            // Contatori sui pulsanti
            if (selectedAteco.size > 0) {
                atecoCountEl.textContent = selectedAteco.size;
                atecoCountEl.classList.remove('hidden');
            } else {
                atecoCountEl.classList.add('hidden');
            }
            
            if (selectedProvincie.size > 0) {
                provinciaCountEl.textContent = selectedProvincie.size;
                provinciaCountEl.classList.remove('hidden');
            } else {
                provinciaCountEl.classList.add('hidden');
            }
            
            // Contatori temporanei nei pannelli
            const atecoTempCount = document.getElementById('atecoTempCount');
            const atecoTempCountValue = document.getElementById('atecoTempCountValue');
            if (selectedAteco.size > 0) {
                atecoTempCountValue.textContent = selectedAteco.size;
                atecoTempCount.classList.remove('hidden');
            } else {
                atecoTempCount.classList.add('hidden');
            }
            
            const provinciaTempCount = document.getElementById('provinciaTempCount');
            const provinciaTempCountValue = document.getElementById('provinciaTempCountValue');
            if (selectedProvincie.size > 0) {
                provinciaTempCountValue.textContent = selectedProvincie.size;
                provinciaTempCount.classList.remove('hidden');
            } else {
                provinciaTempCount.classList.add('hidden');
            }
        }
        
        function getFilteredCompanies() {
            let companies = allData[currentCategory] || [];
            
            // Applica filtro ATECO
            if (selectedAteco.size > 0) {
                companies = companies.filter(c => 
                    c.codiceAteco && selectedAteco.has(c.codiceAteco.trim())
                );
            }
            
            // Applica filtro Provincia
            if (selectedProvincie.size > 0) {
                companies = companies.filter(c => 
                    c.provincia && selectedProvincie.has(c.provincia.trim())
                );
            }
            
            return companies;
        }

        // ============================================
        // RENDERING
        // ============================================
        function renderSlide() {
            const companies = getFilteredCompanies();
            const slideContent = document.getElementById('slideContent');
            
            if (companies.length === 0) {
                slideContent.innerHTML = `
                    <div class="h-full flex items-center justify-center text-gray-400">
                        <div class="text-center">
                            <div class="text-6xl mb-4">üìã</div>
                            <div class="text-lg font-semibold">Nessuna azienda trovata</div>
                            <div class="text-sm mt-2">Prova a modificare i filtri o la categoria</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            const start = currentSlide * COMPANIES_PER_SLIDE;
            const end = Math.min(start + COMPANIES_PER_SLIDE, companies.length);
            const slideCompanies = companies.slice(start, end);
            
            slideContent.innerHTML = slideCompanies.map(c => {
                // Costruisci location string senza parentesi vuote
                let locationStr = `üìç ${c.provincia || 'N/A'}`;
                if (c.regione && c.regione.trim() !== '') {
                    locationStr += ` (${c.regione})`;
                }
                
                return `
                <div class="flex-1 border-l-4 border-blue-600 pl-5 relative group">
                    <h2 class="text-xl font-bold text-gray-900 mb-2">${c.ragioneSociale}</h2>
                    <div class="flex items-center gap-4 text-base mb-2.5 flex-wrap">
                        <span class="text-blue-700 font-bold">${locationStr}</span>
                        <span class="text-gray-700 font-semibold">üìÖ ${formatDateOnly(c.chiusuraBilancio)}</span>
                    </div>
                    <div class="grid grid-cols-5 gap-2.5 mb-3">
                        <div class="bg-blue-50 rounded-lg p-2.5">
                            <div class="text-xs text-gray-600 mb-1 font-semibold">Ricavi 2024</div>
                            <div class="text-lg font-bold text-blue-900">${formatMillionsEU(c.revenue2024)}</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-2.5">
                            <div class="text-xs text-gray-600 mb-1 font-semibold">EBITDA 2024</div>
                            <div class="text-lg font-bold text-green-700">${formatMillionsEU(c.ebitda2024)}</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-2.5">
                            <div class="text-xs text-gray-600 mb-1 font-semibold">EBITDA Margin %</div>
                            <div class="text-lg font-bold text-purple-700">${formatPercentageDirect(c.margine2024)}</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-2.5">
                            <div class="text-xs text-gray-600 mb-1 font-semibold">CAGR '21-'24</div>
                            <div class="text-lg font-bold text-orange-700">${formatCAGR(c.cagr)}</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2.5">
                            <div class="text-xs text-gray-600 mb-1 font-semibold">Website</div>
                            <a href="${formatWebsiteUrl(c.sitoWeb)}" target="_blank" class="text-xs font-bold text-blue-600 hover:text-blue-800 underline truncate block">
                                ${c.sitoWeb || 'N/A'}
                            </a>
                        </div>
                    </div>
                    <div class="mb-2.5 text-sm">
                        <strong>CF:</strong> <span class="font-mono bg-gray-100 px-2.5 py-1 rounded select-all font-semibold">${c.codiceFiscale || c.partitaIva || 'N/A'}</span>
                    </div>
                    <div class="text-base text-gray-900 mb-3 space-y-2">
                        ${c.settore ? `<div class="bg-blue-100 p-3 rounded-lg border-l-4 border-blue-600"><strong class="text-blue-900 text-lg">üè¢ Settore:</strong> <span class="font-semibold">${c.settore}</span></div>` : ''}
                        ${c.note ? `<div class="bg-yellow-100 p-3 rounded-lg border-l-4 border-yellow-500"><strong class="text-yellow-900 text-lg">üìù Note:</strong> <span class="font-medium italic">${c.note}</span></div>` : ''}
                    </div>
                    <div class="flex gap-2.5">
                        ${getActionButtons(c.ragioneSociale)}
                    </div>
                </div>
            `;
            }).join('');
            
            // Aggiungi disclaimer e fonte in basso a sinistra con margine adeguato
            const disclaimer = document.createElement('div');
            disclaimer.className = 'absolute bottom-6 left-8 text-[10px] text-gray-500 space-y-1 max-w-2xl leading-snug';
            disclaimer.innerHTML = `
                <p class="italic font-medium">‚ö†Ô∏è I dati rappresentati potrebbero non essere pienamente attendibili, in quanto non consolidati.</p>
                <p class="text-[9px]">
                    <strong>Fonte:</strong> Aida - Aziende con "Ricavi '24 tra ‚Ç¨ 15-35M, EBITDA Margin '24 >10%, CAGR Ricavi '21-'24 >5%" ‚Ä¢ <strong>Rielaborazione:</strong> Claude
                </p>
            `;
            slideContent.appendChild(disclaimer);
            
            attachEventListeners();
        }

        function getActionButtons(ragioneSociale) {
            const buttons = {
                daValutare: `
                    <button onclick="moveToPreferiti('${ragioneSociale}')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">
                        ‚≠ê Preferito
                    </button>
                    <button onclick="moveToScartati('${ragioneSociale}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">
                        üóëÔ∏è Scarta
                    </button>
                `,
                preferiti: `
                    <button onclick="moveToScartati('${ragioneSociale}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">
                        üóëÔ∏è Scarta
                    </button>
                    <button onclick="ripristinaAzienda('${ragioneSociale}')" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold text-sm">
                        ‚Ü©Ô∏è Rimuovi
                    </button>
                `,
                scartati: `
                    <button onclick="moveToPreferiti('${ragioneSociale}')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">
                        ‚≠ê Preferito
                    </button>
                    <button onclick="ripristinaAzienda('${ragioneSociale}')" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold text-sm">
                        ‚Ü©Ô∏è Rimuovi
                    </button>
                `
            };
            return buttons[currentCategory] || '';
        }

        function attachEventListeners() {
            // Event listeners are inline with onclick
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function prevSlide() {
            if (currentSlide > 0) {
                currentSlide--;
                renderSlide();
                updateNavigation();
            }
        }

        function nextSlide() {
            const companies = getFilteredCompanies();
            const totalSlides = Math.ceil(companies.length / COMPANIES_PER_SLIDE);
            if (currentSlide < totalSlides - 1) {
                currentSlide++;
                renderSlide();
                updateNavigation();
            }
        }

        function goToSlide(index) {
            currentSlide = index;
            renderSlide();
            updateNavigation();
        }

        function updateNavigation() {
            const companies = getFilteredCompanies();
            const totalSlides = Math.ceil(companies.length / COMPANIES_PER_SLIDE);
            
            document.getElementById('prevBtn').disabled = currentSlide === 0;
            document.getElementById('nextBtn').disabled = currentSlide >= totalSlides - 1 || companies.length === 0;
            
            document.getElementById('currentSlide').textContent = companies.length > 0 ? currentSlide + 1 : 0;
            document.getElementById('totalSlides').textContent = totalSlides || 0;
            
            const navDots = document.getElementById('navDots');
            navDots.innerHTML = '';
            const maxDots = Math.min(15, totalSlides);
            for (let i = 0; i < maxDots; i++) {
                const dot = document.createElement('button');
                dot.className = `transition-all ${i === currentSlide ? 'w-8 h-3 bg-blue-600 rounded-full' : 'w-3 h-3 bg-gray-300 rounded-full hover:bg-gray-400'}`;
                dot.onclick = () => goToSlide(i);
                navDots.appendChild(dot);
            }
            
            if (companies.length === 0) {
                document.getElementById('navInfo').textContent = `üìä 0 aziende visibili`;
            } else {
                const start = currentSlide * COMPANIES_PER_SLIDE + 1;
                const end = Math.min((currentSlide + 1) * COMPANIES_PER_SLIDE, companies.length);
                document.getElementById('navInfo').textContent = `üìä Aziende ${start}-${end} di ${companies.length} visibili`;
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function updateCounts() {
            document.querySelectorAll('.category-btn').forEach(btn => {
                const category = btn.dataset.category;
                const count = allData[category]?.length || 0;
                btn.querySelector('.count').textContent = count;
            });
            
            const total = (allData.daValutare?.length || 0) + (allData.preferiti?.length || 0) + (allData.scartati?.length || 0);
            document.getElementById('totalCount').textContent = total;
        }

        function formatMillionsEU(value) {
            if (!value || value === 0) return 'N/A';
            const num = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.-]/g, '')) : value;
            // Converti da migliaia a milioni e usa virgola per decimali
            return `‚Ç¨ ${(num / 1000).toFixed(1).replace('.', ',')}M`;
        }

        function formatPercentageDirect(value) {
            if (!value || value === 0) return 'N/A';
            const num = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.-]/g, '')) : value;
            return `${num.toFixed(2).replace('.', ',')}%`;
        }

        function formatCAGR(value) {
            if (!value || value === 0) return 'N/A';
            const num = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.-]/g, '')) : value;
            // Converti decimale in percentuale (0,0968 ‚Üí +9,68%)
            const percentage = (num * 100).toFixed(2).replace('.', ',');
            return num >= 0 ? `+${percentage}%` : `${percentage}%`;
        }

        function formatDateOnly(dateValue) {
            if (!dateValue) return 'N/A';
            
            try {
                // Se √® gi√† una stringa in formato data
                if (typeof dateValue === 'string') {
                    // Se contiene spazi (es: "2024-12-31 00:00:00"), prendi solo la parte della data
                    if (dateValue.includes(' ')) {
                        return dateValue.split(' ')[0];
                    }
                    // Se contiene "T" (formato ISO), prendi solo la parte prima di T
                    if (dateValue.includes('T')) {
                        return dateValue.split('T')[0];
                    }
                    // Se √® gi√† nel formato corretto o contiene "-" o "/", usa cos√¨
                    if (dateValue.includes('-') || dateValue.includes('/')) {
                        return dateValue.replace(/\//g, '-');
                    }
                }
                
                // Se √® un numero seriale di Excel (numero di giorni da 01/01/1900)
                if (typeof dateValue === 'number') {
                    // Formula Excel: (numero - 25569) * 86400 * 1000 = timestamp Unix
                    const date = new Date((dateValue - 25569) * 86400 * 1000);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                // Se √® un oggetto Date
                if (dateValue instanceof Date) {
                    const year = dateValue.getFullYear();
                    const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                    const day = String(dateValue.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                return dateValue.toString().split(' ')[0];
            } catch (e) {
                console.error('Errore formato data:', e);
                return 'N/A';
            }
        }

        function formatDate(dateValue) {
            if (!dateValue) return 'N/A';
            // Se √® gi√† una stringa in formato data, restituiscila
            if (typeof dateValue === 'string') {
                // Se contiene gi√† "-" o "/" √® probabilmente gi√† formattata
                if (dateValue.includes('-') || dateValue.includes('/')) {
                    return dateValue;
                }
            }
            // Se √® un numero seriale di Excel, convertilo
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            return dateValue.toString();
        }

        function formatWebsiteUrl(website) {
            if (!website) return '#';
            // Se ha gi√† http/https, usalo direttamente
            if (website.startsWith('http://') || website.startsWith('https://')) {
                return website;
            }
            // Altrimenti aggiungi https://
            return `https://${website}`;
        }

        function formatMillions(value) {
            if (!value || value === 0) return 'N/A';
            const num = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.-]/g, '')) : value;
            return `‚Ç¨${(num / 1000).toFixed(1)}M`;
        }

        function formatPercentage(value) {
            if (!value || value === 0) return 'N/A';
            const num = typeof value === 'string' ? parseFloat(value.replace(/[^0-9.-]/g, '')) : value;
            return `${num.toFixed(1)}%`;
        }

        function getGoogleSearchUrl(website) {
            if (!website) return '#';
            const clean = website.replace(/^(https?:\/\/)?(www\.)?/, '');
            return `https://www.google.com/search?q=${encodeURIComponent(clean)}`;
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function showNotification(message, type) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-xl z-50 font-semibold ${
                type === 'error' ? 'bg-red-600' : 'bg-green-600'
            } text-white`;
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 3000);
        }

        function updateLastUpdateTime() {
            if (!lastUpdate) return;
            const diff = Math.floor((new Date() - lastUpdate) / 60000);
            document.getElementById('lastUpdate').textContent = diff === 0 ? 'Appena aggiornato' : `${diff} min fa`;
        }

        function startAutoRefresh() {
            setInterval(() => loadData(), AUTO_REFRESH_INTERVAL);
            setInterval(() => updateLastUpdateTime(), 10000);
        }
    </script>
</body>
</html>
